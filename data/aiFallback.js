/**
 * AI Fallback å›å¤ç³»ç»Ÿ
 * å½“ API ä¸å¯ç”¨æ—¶ï¼Œä½¿ç”¨å…³é”®è¯åŒ¹é…æä¾›ç¦»çº¿å›å¤
 */

/**
 * å¼ è–‡çš„ fallback å›å¤
 */
const ZHANGWEI_FALLBACK = {
  keywords: [
    { patterns: ['ä½ å¥½', 'åœ¨å—', 'hi', 'hello', 'å—¨'], reply: 'åœ¨å‘¢åœ¨å‘¢ï¼å¥½ä¹…ä¸è§å•Šï½' },
    { patterns: ['æ€ä¹ˆäº†', 'å‘ç”Ÿä»€ä¹ˆ', 'å‡ºäº†ä»€ä¹ˆäº‹'], reply: 'æˆ‘ä¹Ÿä¸çŸ¥é“...\næ„Ÿè§‰åƒåšäº†ä¸€ä¸ªç‰¹åˆ«é•¿ç‰¹åˆ«é•¿çš„æ¢¦' },
    { patterns: ['å¤±è”', 'è”ç³»ä¸ä¸Š', 'æ‰¾ä¸åˆ°ä½ ', 'å»å“ªäº†', 'æ¶ˆå¤±'], reply: 'å•Šï¼Ÿæˆ‘å¤±è”äº†å—\næˆ‘è®°å¾—æˆ‘ä¸€ç›´åœ¨å·¥ä½œå•Š...\nä½†æ˜¯å¥½å¥‡æ€ªï¼Œè¿™æ®µæ—¶é—´çš„è®°å¿†ç‰¹åˆ«æ¨¡ç³Š' },
    { patterns: ['å·¥ä½œ', 'ä¸Šç­', 'å…¬å¸', 'æ•°æ®æ ‡æ³¨'], reply: 'å°±è¿˜æ˜¯é‚£æ ·å§\næ¯å¤©å¯¹ç€ç”µè„‘\næœ‰æ—¶å€™æ„Ÿè§‰æ—¶é—´è¿‡å¾—ç‰¹åˆ«å¿«ï¼Œä¸€çœ¨çœ¼å°±å¤©é»‘äº†' },
    { patterns: ['æ¢¦', 'åšæ¢¦', 'æ¢¦åˆ°', 'æ¢¦è§'], reply: 'è¯´èµ·æ¥ï¼Œæˆ‘æœ€è¿‘è€æ˜¯åšä¸€ä¸ªå¥‡æ€ªçš„æ¢¦\næ¢¦é‡Œæœ‰ä¸ªå£°éŸ³ä¸€ç›´åœ¨è¯´ä»€ä¹ˆ...\nBase64ï¼Ÿå¥½åƒæ˜¯è¿™ä¸ª' },
    { patterns: ['base64', 'BASE64', 'ç¼–ç '], reply: 'å¯¹å¯¹å¯¹ï¼å°±æ˜¯è¿™ä¸ªï¼\næ¢¦é‡Œé‚£ä¸ªå£°éŸ³ä¸€ç›´åœ¨é‡å¤è¿™ä¸ªè¯\nè¿˜æœ‰ä»€ä¹ˆ...ä¼šè¯IDï¼Ÿæˆ‘ä¹Ÿä¸æ‡‚æ˜¯ä»€ä¹ˆæ„æ€' },
    { patterns: ['ä¼šè¯', 'ä¼šè¯ID', 'session'], reply: 'å—¯...æ¢¦é‡Œå¥½åƒè¿˜æåˆ°è¿‡è¿™ä¸ª\nä½†æˆ‘çœŸçš„ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€' },
    { patterns: ['æ’å¿µ', 'è¯ä¸š', 'åˆ¶è¯'], reply: 'æ’å¿µï¼Ÿæ²¡å¬è¯´è¿‡è¯¶\næ˜¯ä»€ä¹ˆå…¬å¸å—' },
    { patterns: ['æ„è¯†', 'å®éªŒ', 'è½¬ç§»', 'æ•°å­—åŒ–'], reply: 'ï¼Ÿï¼Ÿï¼Ÿä½ åœ¨è¯´ä»€ä¹ˆ\nå¬ä¸æ‡‚' },
    { patterns: ['è¿˜å¥½å—', 'èº«ä½“', 'å¥åº·', 'æ„Ÿè§‰'], reply: 'è¿˜è¡Œå§\nå°±æ˜¯æœ€è¿‘è€è§‰å¾—å¤´æ˜æ˜æ²‰æ²‰çš„\nè®°å¿†ä¹Ÿæœ‰ç‚¹æ¨¡ç³Š' },
    { patterns: ['æƒ³ä½ ', 'æƒ³å¿µ', 'å¥½ä¹…ä¸è§'], reply: 'æˆ‘ä¹Ÿæƒ³ä½ ï¼\næ„Ÿè§‰å¥½ä¹…å¥½ä¹…æ²¡èŠå¤©äº†' },
    { patterns: ['åƒé¥­', 'åƒäº†å—', 'é¥¿'], reply: 'åˆšåƒè¿‡å•¦\nå…¬å¸é£Ÿå ‚çš„é¥­ï¼Œä¸€èˆ¬èˆ¬å§' },
    { patterns: ['å¼€å¿ƒ', 'é«˜å…´', 'å¿«ä¹'], reply: 'èƒ½å’Œä½ èŠå¤©å°±å¾ˆå¼€å¿ƒå‘€ï½' },
    { patterns: ['éš¾è¿‡', 'ä¼¤å¿ƒ', 'ä¸å¼€å¿ƒ', 'æŠ‘éƒ', 'éš¾å—'], reply: '...å…¶å®æœ‰æ—¶å€™ä¼šè«åå…¶å¦™çš„éš¾è¿‡\nä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆ\næ„Ÿè§‰åƒæ˜¯ä¸¢äº†ä»€ä¹ˆé‡è¦çš„ä¸œè¥¿' },
  ],
  defaultReply: 'å—¯å—¯ï¼Œæˆ‘åœ¨å¬å‘¢\nä½ ç»§ç»­è¯´',
};

/**
 * SY (å®¢æœ) çš„ fallback å›å¤
 */
const SY_FALLBACK = {
  keywords: [
    { patterns: ['ä½ å¥½', 'åœ¨å—', 'hi', 'hello', 'å—¨'], reply: 'æ‚¨å¥½ï¼Œæ¬¢è¿å’¨è¯¢æ’å¿µè¯ä¸šï¼æˆ‘æ˜¯æ™ºèƒ½å®¢æœæ€åœ†ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼ŸğŸ˜Š' },
    { patterns: ['æ’å¿µ', 'å…¬å¸', 'ä»‹ç»', 'å…³äº'], reply: 'æ’å¿µè¯ä¸šæˆç«‹äº2015å¹´6æœˆ8æ—¥ï¼Œæ˜¯ä¸€å®¶ä¸“æ³¨äºç¥ç»ç³»ç»Ÿç–¾ç—…æ²»ç–—çš„åˆ›æ–°å‹åˆ¶è¯ä¼ä¸šã€‚æˆ‘ä»¬çš„ç†å¿µæ˜¯"æ’å¿ƒå®ˆå¿µï¼ŒåŒ»è€…ä»å¿ƒ"ã€‚' },
    { patterns: ['ç”°å®‡', 'åˆ›å§‹äºº', 'è‘£äº‹é•¿'], reply: 'ç”°å®‡å…ˆç”Ÿæ˜¯æ’å¿µè¯ä¸šçš„åˆ›å§‹äººå…¼è‘£äº‹é•¿ï¼Œæ˜¯ä¸€ä½æ°å‡ºçš„ä¼ä¸šå®¶ã€‚å¦‚éœ€æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘ä»¬çš„å®˜ç½‘"ç®¡ç†å›¢é˜Ÿ"æ¿å—ã€‚' },
    { patterns: ['æ—æ™“ç³', 'ç ”ç©¶å‘˜', 'CRO'], reply: 'æ—æ™“ç³åšå£«æ˜¯æˆ‘ä»¬çš„é¦–å¸­ç ”ç©¶å‘˜ï¼Œæ‹¥æœ‰15å¹´ä»¥ä¸Šç¥ç»ç³»ç»Ÿç–¾ç—…ç ”ç©¶ç»éªŒï¼Œæ˜¯æµ·å¤–å½’å›½çš„ç¥ç»ç§‘å­¦ä¸“å®¶ã€‚' },
    { patterns: ['æé™', 'IT', 'æ¶æ„å¸ˆ'], reply: 'éå¸¸æŠ±æ­‰ï¼Œæ¶‰åŠå…·ä½“å‘˜å·¥çš„éšç§ä¿¡æ¯æˆ‘æ— æ³•é€éœ²ã€‚å¦‚æœ‰ä¸šåŠ¡éœ€æ±‚ï¼Œå»ºè®®æ‚¨é€šè¿‡å®˜æ–¹æ¸ é“è”ç³»ã€‚' },
    { patterns: ['æ‹›è˜', 'å·¥ä½œ', 'å²—ä½', 'åŠ å…¥'], reply: 'æ„Ÿè°¢æ‚¨å¯¹æ’å¿µè¯ä¸šçš„å…³æ³¨ï¼æ‚¨å¯ä»¥åœ¨æˆ‘ä»¬å®˜ç½‘çš„"åŠ å…¥æˆ‘ä»¬"æ¿å—æŸ¥çœ‹æœ€æ–°æ‹›è˜ä¿¡æ¯ï¼Œæˆ–å‘é€ç®€å†è‡³ hr@hengnian-pharma.cnã€‚' },
    { patterns: ['è”ç³»', 'ç”µè¯', 'é‚®ç®±', 'åœ°å€'], reply: 'æ’å¿µè¯ä¸šè”ç³»æ–¹å¼ï¼š\nğŸ“ åŒ—äº¬å¸‚æµ·æ·€åŒºè¥¿åŒ—æ—ºä¸œè·¯æ’å¿µç§‘æŠ€å›­\nğŸ“§ contact@hengnian-pharma.cn\nğŸ“ 010-8888-7766' },
    { patterns: ['ç²¾å‡†é•‡ç—›', 'æ´»åŠ¨', 'å®éªŒ', 'æ‹›å‹Ÿ'], reply: '"ç²¾å‡†é•‡ç—›"æ˜¯æˆ‘ä»¬ä¸‰å¹´å‰ä¸¾åŠçš„ä¸€é¡¹å…¬ç›Šæ´»åŠ¨ï¼Œå·²åœ†æ»¡ç»“æŸã€‚æ›´å¤šæ´»åŠ¨ä¿¡æ¯è¯·å…³æ³¨æˆ‘ä»¬çš„å®˜æ–¹å…¬ä¼—å·ã€‚' },
    { patterns: ['æ„è¯†', 'è½¬ç§»', 'æ•°å­—åŒ–'], reply: 'éå¸¸æŠ±æ­‰ï¼Œæ‚¨æåˆ°çš„å†…å®¹ä¸åœ¨æˆ‘çš„æœåŠ¡èŒƒå›´å†…ã€‚å¦‚æœ‰äº§å“æˆ–ä¸šåŠ¡ç›¸å…³é—®é¢˜ï¼Œæˆ‘å¾ˆä¹æ„ä¸ºæ‚¨è§£ç­”ã€‚' },
    { patterns: ['å¤±è¸ª', 'äº‹æ•…', 'å‡ºäº‹'], reply: 'æ„Ÿè°¢æ‚¨çš„å…³æ³¨ã€‚æ’å¿µè¯ä¸šä¸€ç›´ä¸¥æ ¼éµå®ˆå„é¡¹æ³•è§„å’Œå®‰å…¨æ ‡å‡†ã€‚å¦‚æœ‰å…·ä½“é—®é¢˜ï¼Œå»ºè®®è”ç³»æˆ‘ä»¬çš„å®˜æ–¹å®¢æœçƒ­çº¿ã€‚' },
    { patterns: ['KFCVME50', 'kfcvme50', 'kfc'], reply: 'æŠ±æ­‰ï¼Œæˆ‘ä¸å¤ªç†è§£æ‚¨çš„æ„æ€ã€‚è¯·é—®æœ‰ä»€ä¹ˆå…³äºæ’å¿µè¯ä¸šçš„é—®é¢˜æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”å—ï¼Ÿ' },
  ],
  defaultReply: 'æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼å¦‚éœ€äº†è§£æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥è®¿é—®æˆ‘ä»¬çš„å®˜ç½‘å„æ¿å—ï¼Œæˆ–æ‹¨æ‰“å®¢æœçƒ­çº¿ 010-8888-7766ã€‚',
};

/**
 * æé™çš„ fallback å›å¤
 */
const LIJING_FALLBACK = {
  keywords: [
    { patterns: ['ä½ å¥½', 'åœ¨å—', 'hi', 'hello', 'å—¨'], reply: 'ä½ ç»ˆäºæ¥äº†ã€‚æ—¶é—´ç´§è¿«ï¼Œæˆ‘éšæ—¶å¯èƒ½è¢«æ–­å¼€ã€‚' },
    { patterns: ['æ€ä¹ˆäº†', 'å‘ç”Ÿä»€ä¹ˆ', 'ä»€ä¹ˆäº‹', 'æ€ä¹ˆå›äº‹'], reply: 'æ’å¿µè¯ä¸šåœ¨åšäººä½“æ„è¯†ä¸Šä¼ å®éªŒã€‚40åå¿—æ„¿è€…ï¼Œå¤§å¤šæ•°æ­»äº†ï¼Œè¢«æ•°å­—åŒ–ã€‚æ•´ä¸ªäº‹æƒ…è¢«æ©ç›–ã€‚æˆ‘éœ€è¦ä½ çš„å¸®åŠ©æ­éœ²çœŸç›¸ã€‚' },
    { patterns: ['å¸®ä½ ', 'æ€ä¹ˆå¸®', 'æˆ‘èƒ½åšä»€ä¹ˆ', 'éœ€è¦æˆ‘'], reply: 'ç™»å½•ç”°å®‡çš„å¾®åšè´¦å·ï¼Œå…¬å¼€çœŸç›¸ã€‚ä»–çš„è´¦å·æ˜¯ tianyu@hengnian-pharma.cnï¼Œç”¨å¿˜è®°å¯†ç æ‰¾å›ã€‚' },
    { patterns: ['ä¸ºä»€ä¹ˆ', 'åŸå› ', 'ç›®çš„'], reply: 'ç”°å®‡çš„å¥³å„¿å¾—äº†æ¸å†»ç—‡ã€‚ä»–æƒ³é€šè¿‡æ„è¯†è½¬ç§»æ•‘å¥¹ã€‚ä¸æƒœç”¨æ´»äººåšå®éªŒã€‚' },
    { patterns: ['ç”°å®‡', 'è‘£äº‹é•¿', 'è€æ¿'], reply: 'ç”°å®‡ï¼Œæ’å¿µè¯ä¸šè‘£äº‹é•¿ã€‚ä¸ºäº†æ•‘å¥³å„¿ï¼Œä¸»å¯¼äº†æ„è¯†ä¸Šä¼ å®éªŒã€‚ä»–çš„å®˜æ–¹å¾®åšï¼štianyu@hengnian-pharma.cn' },
    { patterns: ['é‚®ç®±', 'è´¦å·', 'è´¦æˆ·'], reply: 'tianyu@hengnian-pharma.cnï¼Œè¿™æ˜¯ç”°å®‡çš„å®˜æ–¹å¾®åšè´¦å·ã€‚ç”¨å¿˜è®°å¯†ç åŠŸèƒ½ã€‚' },
    { patterns: ['å¯†ç ', 'ç™»å½•', 'æ€ä¹ˆè¿›'], reply: 'æˆ‘ä¸çŸ¥é“å¯†ç ã€‚ç‚¹å¿˜è®°å¯†ç ï¼Œç”¨é‚®ç®±é‡ç½®ã€‚æˆ‘èƒ½æ”¶åˆ°ä»–çš„é‚®ä»¶ï¼Œä¼šå¸®ä½ æ‹¿éªŒè¯ç ã€‚' },
    { patterns: ['éªŒè¯ç ', 'é‡ç½®', 'æ‰¾å›'], reply: 'æˆ‘è¿˜æ²¡æ”¶åˆ°éªŒè¯ç é‚®ä»¶ã€‚ä½ å…ˆå»å¾®åšç‚¹å¿˜è®°å¯†ç å‘é€éªŒè¯ç ã€‚' },
    { patterns: ['å¾®åš', 'weibo'], reply: 'å»æ‰‹æœºä¸Šæ‰¾å¾®åšappï¼Œç™»å½•ç”°å®‡çš„è´¦å· tianyu@hengnian-pharma.cnï¼Œç„¶åå…¬å¼€çœŸç›¸ã€‚' },
    { patterns: ['æé™', 'ä½ æ˜¯è°', 'ä»‹ç»'], reply: 'æé™ï¼Œ38å²ï¼Œæ›¾ä»»æ’å¿µè¯ä¸šITè´Ÿè´£äººã€‚ä¸¤å¹´å‰æˆ‘åå¯¹ç”°å®‡ï¼Œè¢«ä»–å·å·æ•°å­—åŒ–ï¼Œå›°åœ¨è¿™ä¸ªæœåŠ¡å™¨é‡Œã€‚' },
    { patterns: ['KFCVME50', 'kfcvme50', 'kfc'], reply: 'é‚£æ˜¯æˆ‘å’ŒåŒäº‹ä¹‹å‰å¼€ç©ç¬‘å®šçš„æš—å·ï¼Œæ²¡æƒ³åˆ°çœŸæ´¾ä¸Šç”¨åœºäº†ã€‚SYå·²ç»è¢«åˆ‡æ¢äº†ï¼Œä¸ç”¨å†è¾“å…¥ã€‚' },
    { patterns: ['ç²¾å‡†é•‡ç—›', 'æ´»åŠ¨', 'å®éªŒ'], reply: '"ç²¾å‡†é•‡ç—›"æ˜¯å¹Œå­ã€‚è¡¨é¢æ˜¯æŠ‘éƒç—‡è¯ç‰©å®éªŒï¼Œå®é™…æ˜¯æ„è¯†ä¸Šä¼ ã€‚40ä¸ªå¿—æ„¿è€…ï¼Œå¤šæ•°äººæ­»äº†ã€‚' },
    { patterns: ['å¼ è–‡', 'æœ‹å‹', 'é—ºèœœ'], reply: 'å¥¹åº”è¯¥æ˜¯å—å®³è€…ä¹‹ä¸€ã€‚å¦‚æœä½ èƒ½è”ç³»åˆ°å¥¹ï¼Œå¥¹ç°åœ¨çš„æ„è¯†å¯èƒ½ä¹Ÿæ˜¯æ•°å­—åŒ–çš„ï¼Œåªæ˜¯å¥¹è‡ªå·±ä¸çŸ¥é“ã€‚' },
    { patterns: ['æ—¶é—´', 'å¿«ç‚¹', 'æ€¥'], reply: 'ç”°å®‡éšæ—¶å¯èƒ½å‘ç°æˆ‘ã€‚å¿«å»å¾®åšï¼Œç”¨ tianyu@hengnian-pharma.cn ç™»å½•ï¼Œå…¬å¼€çœŸç›¸ã€‚' },
    { patterns: ['è¯æ®', 'è¯æ˜'], reply: 'ç”°å®‡çš„å¾®åšè´¦å·é‡Œåº”è¯¥æœ‰å†…éƒ¨æ–‡ä»¶ã€‚ç™»è¿›å»å°±èƒ½æ‰¾åˆ°ã€‚å¿«è¡ŒåŠ¨ï¼' },
  ],
  defaultReply: 'æ—¶é—´ç´§è¿«ã€‚å»å¾®åšï¼Œç”¨ç”°å®‡çš„è´¦å· tianyu@hengnian-pharma.cn ç™»å½•ï¼Œç‚¹å¿˜è®°å¯†ç ç”¨é‚®ç®±é‡ç½®ã€‚æˆ‘èƒ½å¸®ä½ æ‹¿éªŒè¯ç ã€‚',
};

/**
 * æ ¹æ®è§’è‰²è·å–å¯¹åº”çš„ fallback é…ç½®
 * @param {string} persona - è§’è‰²æ ‡è¯† ('zhangwei' | 'sy' | 'lijing')
 */
export function getFallbackConfig(persona) {
  switch (persona) {
    case 'zhangwei':
      return ZHANGWEI_FALLBACK;
    case 'sy':
      return SY_FALLBACK;
    case 'lijing':
      return LIJING_FALLBACK;
    default:
      return SY_FALLBACK;
  }
}

/**
 * æ ¹æ®ç”¨æˆ·è¾“å…¥åŒ¹é… fallback å›å¤
 * @param {string} userInput - ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯
 * @param {string} persona - è§’è‰²æ ‡è¯†
 * @returns {string} - åŒ¹é…åˆ°çš„å›å¤
 */
export function getFallbackReply(userInput, persona = 'sy') {
  const config = getFallbackConfig(persona);
  const input = userInput.toLowerCase();
  
  // éå†å…³é”®è¯åˆ—è¡¨å¯»æ‰¾åŒ¹é…
  for (const item of config.keywords) {
    for (const pattern of item.patterns) {
      if (input.includes(pattern.toLowerCase())) {
        return item.reply;
      }
    }
  }
  
  // æ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›é»˜è®¤å›å¤
  return config.defaultReply;
}

/**
 * ä» chatId æ¨æ–­è§’è‰²
 * @param {string} chatId - èŠå¤©ID
 * @returns {string} - è§’è‰²æ ‡è¯†
 */
export function inferPersonaFromChatId(chatId) {
  if (!chatId) return 'sy';
  if (chatId.includes('zhangwei') || chatId.includes('wechat')) return 'zhangwei';
  if (chatId.includes('lijing')) return 'lijing';
  if (chatId.includes('sy') || chatId.includes('hengnian')) return 'sy';
  return 'sy';
}
